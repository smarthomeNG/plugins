 <!DOCTYPE html>
{% extends "base.html" %}
{% import "navbar.html" as nav with context %}
{% block navbar %}
    {{ nav }}
{% endblock navbar %}
{% block content %}

 <div class="container">
      <strong>Items (gesamt: {{ smarthome.item_count }})</strong><span id="search-results"></span><br/><br/>
      <div class="form-group">
          <input type="input" class="form-control" id="input-search" placeholder="Itempfad suchen..." value=""><br/>
          <button type="button" class="btn btn-success" id="btn-search">Suchen</button>
          <button type="button" class="btn btn-success expand-node" id="btn-expand-node">Ergebnisse aufklappen</button>

          <button type="button" class="btn btn-default" id="btn-clear-search">Zur&uuml;cksetzen</button>
          <button type="button" class="btn btn-success" id="btn-expand-all">Alle aufklappen</button>
          <button type="button" class="btn btn-danger" id="btn-collapse-all">Alle zuklappen</button>
      </div>

      <div class="pre-scrollable" id="tree" style="float:left; border: 1px solid #ccc; height:650px; max-height:650px; width:600px;"></div>
      <div class=container" style="float:left; margin-left: 5px;">
        <!--refresh widget-->
        <div class="panel panel-default" data-url="/fetch-data">
          <div class="panel-heading"><a class="pull-right" href="#"><span class="fa fa-refresh"></span></a> Item-Informationen</div>
          <div class="panel-body panel-refresh">
            <div class="refresh-container"><i class="refresh-spinner fa fa-spinner fa-spin fa-5x"></i></div>
            <div id="tree_detail" class="refresh-data pre-scrollable" style="height:575px; max-height:575px; width:500px;">
                Item im Baum auswählen um Details einzusehen!
            </div>
          </div>
        </div>
    <!--refresh widget-->
     </div>
 </div>


 <script type="text/javascript" language="javascript">
 

function getDetailInfo(item_path) {
    var item = [];
    $.getJSON('/item_detail_json.html?item_path='+item_path, function(result) {
        $.each(result, function(index, element) {
            $('#tree_detail').html('<p> Itempath: ' + element.path + '</p>');
            $('#tree_detail').append('<p>Name: ' + element.name + '</p>');
            $('#tree_detail').append('<p>Typ: ' + element.type + '</p>');
            $('#tree_detail').append('<p>Wert (aktueller): ' + element.value + '</p>');
            $('#tree_detail').append('<p>Wert (vorheriger): ' + element.previous_value + '</p>');
            $('#tree_detail').append('<p>Geändert von : ' + element.changed_by + '</p>');
            $('#tree_detail').append('<p>previous_age: ' + element.previous_age + '</p>');
            $('#tree_detail').append('<p>age: ' + element.age + '</p>');
            $('#tree_detail').append('<p>Letzte Änderung: ' + element.last_change  + '</p>');
            $('#tree_detail').append('<p>previous_change: ' + element.previous_change + '</p>');
            $('#tree_detail').append('<p>enforce_updates: ' + element.enforce_updates + '</p>');
            $('#tree_detail').append('<p>eval: ' + element.eval + '</p>');
            $('#tree_detail').append('<p>eval_trigger: ' + element.eval_trigger + '</p>');
            $('#tree_detail').append('<p>threshold: ' + element.threshold + '</p>');
            $('#tree_detail').append('<p>config: ' + element.config + '</p>');
            $('#tree_detail').append('<p>logics: ' + element.logics + '</p>');
            $('#tree_detail').append('<p>triggers: ' + element.triggers + '</p>');
        });

    });
}

function getDetailInfo2(item_path) {
    var item = [];
    var temp ='';
    $.getJSON('/item_detail_json.html?item_path='+item_path, function(result) {
        $.each(result, function(index, element) {
            temp = '<div class="table-responsive"><table class="table table-striped table-hover">';
			temp = temp + '<thead><tr><th>Attribut</th><th>Wert</th></tr></thead><tbody>';
			temp = temp + '<tr><th>Pfad</th><td>'+element.path+'</td></tr>';
			temp = temp + '<tr><th>Name</th><td>'+element.name+'</td></tr>';
			temp = temp + '<tr><th>Typ</th><td>'+element.type+'</td></tr>';
			temp = temp + '<tr><th>Wert (aktueller)</th><td>'+element.value+'</td></tr>';
			temp = temp + '<tr><th>Wert (vorheriger)</th><td>'+element.previous_value+'</td></tr>';
			temp = temp + '<tr><th>Geändert durch</th><td>'+element.changed_by+'</td></tr>';
			temp = temp + '<tr><th>previous_age</th><td>'+element.previous_age+'</td></tr>';
			temp = temp + '<tr><th>age</th><td>'+element.age+'</td></tr>';
			temp = temp + '<tr><th>Letzte Änderung</th><td>'+element.last_change+'</td></tr>';
			temp = temp + '<tr><th>previous_change</th><td>'+element.previous_change+'</td></tr>';
			temp = temp + '<tr><th>enforce_updates</th><td>'+element.enforce_updates+'</td></tr>';
			temp = temp + '<tr><th>eval</th><td>'+element.eval+'</td></tr>';
			temp = temp + '<tr><th>eval_trigger</th><td>'+element.eval_trigger+'</td></tr>';
			temp = temp + '<tr><th>threshold</th><td>'+element.threshold+'</td></tr>';

			temp = temp + '<tr><th></th><td></td></tr>';
			temp = temp + '<tr><th colspan="2">Noch aufzubereitende Daten:</th></tr>';
			temp = temp + '<tr><th>config</th><td>'+element.config+'</td></tr>';
			temp = temp + '<tr><th>logics</th><td>'+element.logics+'</td></tr>';
			temp = temp + '<tr><th>triggers</th><td>'+element.triggers+'</td></tr>';
			
			temp = temp + '</tbody></table></div>';

            $('#tree_detail').html(temp);
        });

    });
}

function build_item_subtree_recursive(data) {
    var result = [];
    var tree_element = {};
    tree_element['text'] = data.path;
    var node_length = data.nodes.length;
    if (data.nodes.length > 0) {
        var child_nodes = [];
        for (var i = 0; i < node_length; i++) {
            var new_child_node = build_item_subtree_recursive(data.nodes[i]);
            child_nodes.push(new_child_node);
        }
        tree_element['tags'] = data.tags;
        tree_element['nodes'] = child_nodes;
    }

    return tree_element;
}

function getTree() {
    var item_tree = [];

    $.getJSON('/items_json.html', function(result) {
        $.each(result, function(index, element) {
            item_tree.push(build_item_subtree_recursive(element));
        });
        $('#tree').treeview({
            data: item_tree,
			levels: 1,
            showTags: true,
            onNodeSelected: function(event, data) {
                item_info = getDetailInfo2(data.text);

            }
        });
    });
    var search = function(e) {
          results = [];
          var pattern = $('#input-search').val();
          var options = {
            ignoreCase: true,
            exactMatch: false,
            revealResults: true
          };
          var results = $('#tree').treeview('search', [ pattern, options ]);
          $('#search-results').html(' - Treffer: '+results.length);


          $('#btn-clear-search').on('click', function (e) {
            $('#tree').treeview('clearSearch');
            $('#input-search').val('');
            $('#search-output').html('');
            results = [];
            $('#search-results').html('');
          });
    }

    $('#btn-search').on('click', search);

    // Expand/collapse all
    $('#btn-expand-all').on('click', function (e) {
      var levels = $('#select-expand-all-levels').val();
      $('#tree').treeview('expandAll', { levels: levels, silent: false });
    });
    $('#btn-collapse-all').on('click', function (e) {
      $('#tree').treeview('collapseAll', { silent: false });
    });
}

getTree();

</script>
{% endblock %}