{% extends "base_plugin.html" %}

{% set logo_frame = false %}

<!-- set update_interval to a value > 0 (in milliseconds) to enable periodic data updates -->
{% set update_interval = 5000 %}

<!-- set update_params if you need to provide additional parameters for the auto-update function-->
<!-- {% set update_params = item_id %}-->

<!-- if you don't need any buttons in the header, disable them completely-->
{% set buttons = true %}

<!-- if you don't need any auto-refresh elements in the header, disable them-->
{% set autorefresh_buttons = false %}

<!-- if you don't need the reload_button in the header, disable it-->
{% set reload_button = false %}

<!-- if you don't need the close in the header, disable it-->
{% set close_button = true %}

<!-- for some situations it might be useful to know the number of datatable rows shown on the current page.
Activate that function if needed, otherwise just remove the line to increase performance -->
{% set row_count = true %}

<!-- if new values should be retrieved using automatic page update right in the beginning and on page changes -->
{% set initial_update = true %}

<!--
	Additional styles go into this block. Examples are for datatables
-->
{% block pluginstyles %}
<style>
  table th.value {
    width: 100px;
  }
  /*
  These are used for highligt effect in web interface when a value changes. If you don't want to overwrite the
  default color, you can remove the entries here as the classes are already defined in smarthomeng.css
  */
  .shng_effect_highlight {
    background-color: #FFFFE0;
  }
  .shng_effect_standard {
    background-color: none;
  }
  .container {
    margin-left: 0!important;
    margin-right: 0!important;
  }
</style>
{% endblock pluginstyles %}

<!--
	Additional script tag for plugin specific javascript code go into this block
-->
{% block pluginscripts %}
<script>
	function handleUpdatedData(response, dataSet=null) {
		if (dataSet === 'devices_info' || dataSet === null) {
			var objResponse = JSON.parse(response);
      
      shngInsertText('bydip',objResponse['bydip']);
      shngInsertText('imppath',objResponse['imppath']);
      shngInsertText('last_homedata',objResponse['last_homedata']);
      shngInsertText('last_diagdata',objResponse['last_diagdata']);

      shngInsertText('current',objResponse['current']);
      shngInsertText('power',objResponse['power']);
      shngInsertText('power_charge',objResponse['power_charge']);
      shngInsertText('power_charge2',objResponse['power_charge']);
      shngInsertText('power_discharge',objResponse['power_discharge']);
      shngInsertText('power_discharge2',objResponse['power_discharge']);
      shngInsertText('soc',objResponse['soc']);
      shngInsertText('soc2',objResponse['soc']);
      shngInsertText('soh',objResponse['soh']);
      shngInsertText('tempbatt',objResponse['tempbatt']);
      shngInsertText('tempmax',objResponse['tempmax']);
      shngInsertText('tempmin',objResponse['tempmin']);
      shngInsertText('voltbatt',objResponse['voltbatt']);
      shngInsertText('voltdiff',objResponse['voltdiff']);
      shngInsertText('voltmax',objResponse['voltmax']);
      shngInsertText('voltmin',objResponse['voltmin']);
      shngInsertText('voltout',objResponse['voltout']);

      shngInsertText('bms',objResponse['bms']);
      shngInsertText('bmu',objResponse['bmu']);
      shngInsertText('bmubanka',objResponse['bmubanka']);
      shngInsertText('bmubankb',objResponse['bmubankb']);
      shngInsertText('batttype',objResponse['batttype']);
      shngInsertText('batttype2',objResponse['batttype']);
      shngInsertText('errorstr',objResponse['errorstr']);
      shngInsertText('grid',objResponse['grid']);
      shngInsertText('invtype',objResponse['invtype']);
      shngInsertText('modules',objResponse['modules']);
      shngInsertText('bmsqty',objResponse['bmsqty']);
      shngInsertText('capacity_total',objResponse['capacity_total']);
      shngInsertText('paramt',objResponse['paramt']);
      shngInsertText('serial',objResponse['serial']);

      shngInsertText('t1_soc',objResponse['t1_soc']);
      shngInsertText('t1_bat_voltag',objResponse['t1_bat_voltag']);
      shngInsertText('t1_v_out',objResponse['t1_v_out']);
      shngInsertText('t1_current',objResponse['t1_current']);
      shngInsertText('t1_volt_max',objResponse['t1_volt_max']);
      shngInsertText('t1_volt_min',objResponse['t1_volt_min']);
      shngInsertText('t1_temp_max',objResponse['t1_temp_max']);
      shngInsertText('t1_temp_min',objResponse['t1_temp_min']);
      shngInsertText('t2_soc',objResponse['t2_soc']);
      shngInsertText('t2_bat_voltag',objResponse['t2_bat_voltag']);
      shngInsertText('t2_v_out',objResponse['t2_v_out']);
      shngInsertText('t2_current',objResponse['t2_current']);
      shngInsertText('t2_volt_max',objResponse['t2_volt_max']);
      shngInsertText('t2_volt_min',objResponse['t2_volt_min']);
      shngInsertText('t2_temp_max',objResponse['t2_temp_max']);
      shngInsertText('t2_temp_min',objResponse['t2_temp_min']);
      shngInsertText('t3_soc',objResponse['t3_soc']);
      shngInsertText('t3_bat_voltag',objResponse['t3_bat_voltag']);
      shngInsertText('t3_v_out',objResponse['t3_v_out']);
      shngInsertText('t3_current',objResponse['t3_current']);
      shngInsertText('t3_volt_max',objResponse['t3_volt_max']);
      shngInsertText('t3_volt_min',objResponse['t3_volt_min']);
      shngInsertText('t3_temp_max',objResponse['t3_temp_max']);
      shngInsertText('t3_temp_min',objResponse['t3_temp_min']);
      
      var source = 'static/img/bydvt1.png',
          timestamp = (new Date()).getTime(),
          newUrl = source + '?_=' + timestamp;
      document.getElementById("bydvt1").src = newUrl;
      var source = 'static/img/bydvt2.png',
          timestamp = (new Date()).getTime(),
          newUrl = source + '?_=' + timestamp;
      document.getElementById("bydvt2").src = newUrl;
      var source = 'static/img/bydvt3.png',
          timestamp = (new Date()).getTime(),
          newUrl = source + '?_=' + timestamp;
      document.getElementById("bydvt3").src = newUrl;
      var source = 'static/img/bydtt1.png',
          timestamp = (new Date()).getTime(),
          newUrl = source + '?_=' + timestamp;
      document.getElementById("bydtt1").src = newUrl;
      var source = 'static/img/bydtt2.png',
          timestamp = (new Date()).getTime(),
          newUrl = source + '?_=' + timestamp;
      document.getElementById("bydtt2").src = newUrl;
      var source = 'static/img/bydtt3.png',
          timestamp = (new Date()).getTime(),
          newUrl = source + '?_=' + timestamp;
      document.getElementById("bydtt3").src = newUrl;
      
		}
	}
</script>
<!--
	This part is used to implement datatable JS for the tables. It allows resorting tables by column, etc.
	For each table you have to implement the code part $('#<table_id>').DataTable(..); where the <table_id> matches the id of a table tag
-->
<script>
    $(document).ready( function () {
		/*
		loading defaults from /modules/http/webif/gstatic/datatables/datatables.defaults.js
		You can copy that file, put it in your plugin directory, rename the "bind" function and
		trigger that function here instead of datatables_defaults if you want to change the behaviour.
		Of course you can also overwrite defaults by putting the option declarations in {} below.
		*/
		$(window).trigger('datatables_defaults');
		{% if webif_pagelength is defined %}webif_pagelength = {{ webif_pagelength|int }};{% endif %}
		if (isNaN(parseFloat(webif_pagelength)) || webif_pagelength == 0) {
			resize = true;
			webif_pagelength = -1;
			console.log('Activating automatic table resize ' + webif_pagelength);
		}
		else {
			resize = false;
		}
		try {
			/*
			Copy this part for every datatable on your page. Adjust options if necessary.
			pageLength and pageResize should be included as they are to adjust it based on the plugin settings
			*/
			maintable = $('#maintable').DataTable( {
			  /* If you want to define your own columnDefs options (e.g. for hiding a column by default), use the concat function shown here.
			  */
			  columnDefs: [{ "targets": [2], "className": "value"}].concat($.fn.dataTable.defaults.columnDefs),
			  pageLength: webif_pagelength,
			  pageResize: resize});
		}
		catch (e) {
			console.warn("Datatable JS not loaded, showing standard table without reorder option " + e);
		}
	});
</script>
<!-- 
<script>
  window.refresh.update({dataSet:'',update_params:'',update_interval: 5000,update_active:true});
</script>
 -->
{% endblock pluginscripts %}


{% block headtable %}
<!-- add a style="min-width:..px;" if you want to define a minimum width for responsive behaviour -->
<table class="table table-striped table-hover">
	<tbody>
		<tr>
			<td class="py-1"><strong>{{ _('Batterietyp') }}:</strong></td>
			<td id="batttype" class="py-1">{{ _('Laden') }} ...</td>
			<td class="py-1" width="50px"></td>
			<td class="py-1"><strong>BYD IP:</strong></td>
			<td id="bydip" class="py-1"></td>
			<td class="py-1" width="50px"></td>
		</tr>
		<tr>
			<td class="py-1"><strong>{{ _('Batterieladung') }}:</strong></td>
			<td id="soc" class="py-1"></td>
			<td class="py-1" width="50px"></td>
			<td class="py-1"><strong>{{ _('Gesamtkapazität') }}:</strong></td>
			<td id="capacity_total" class="py-1"></td>
			<td class="py-1" width="50px"></td>
		</tr>
		<tr>
			<td class="py-1"><strong>{{ _('Ladeleistung') }}:</strong></td>
			<td id="power_charge" class="py-1"></td>
			<td class="py-1" width="50px"></td>
			<td class="py-1"><strong>{{ _('Entladeleistung') }}:</strong></td>
			<td id="power_discharge" class="py-1"></td>
			<td class="py-1" width="50px"></td>
		</tr>
		<tr>
			<td class="py-1"><strong>{{ _('Basisdaten') }}:</strong></td>
			<td id="last_homedata" class="py-1"></td>
			<td class="py-1" width="50px"></td>
			<td class="py-1"><strong>{{ _('Diagnosedaten') }}:</strong></td>
			<td id="last_diagdata" class="py-1"></td>
			<td class="py-1" width="50px"></td>
		</tr>
	</tbody>
</table>
{% endblock headtable %}

<!--
	Additional buttons for the web interface (if any are needed) - displayed below the headtable-section
-->
{% block buttons %}
{% if 1==2 %}
	<div>
		<button id="btn1" class="btn btn-shng btn-sm" name="scan" onclick="shngPost('', {learn: 'on'})"><i class="fas fa-question"></i>&nbsp;&nbsp;&nbsp;{{ _('nach Devices suchen') }}&nbsp;</button>
	</div>
{% endif %}
{% endblock %}

<!--
	Define the number of tabs for the body of the web interface (1 - 6)
-->
{% set tabcount = 4 %}

<!--
	Set the tab that will be visible on start, if another tab that 1 is wanted (1 - 3)
-->
{% if item_count==0 %}
	{% set start_tab = 1 %}
{% endif %}

<!--
	Content block for the first tab of the Webinterface
-->
{% set tab1title = "<strong>"+_('BYD Home')+"</strong>" %}
{% block bodytab1 %}
<div class="container">
  <div class="row">
  <div class="col">
  <p></p>
  <table id="byd_diag_home" border="1">
	  <tbody>
      <tr>
        <td class="py-1"><strong>SOC:</strong></td>
        <td id="soc2" class="py-1" style="text-align: right">{{ _('Laden') }} ...</td>
      </tr>
      <tr>
        <td class="py-1"><strong>SOH:</strong></td>
        <td id="soh" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Leistung') }}:</strong></td>
        <td id="power" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
		  	<td class="py-1"><strong>{{ _('Ladeleistung') }}:</strong></td>
	  		<td id="power_charge2" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
	  		<td class="py-1"><strong>{{ _('Entladeleistung') }}:</strong></td>
	  		<td id="power_discharge2" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Spannung Ausgang') }}:</strong></td>
        <td id="voltout" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Strom Ausgang') }}:</strong></td>
        <td id="current" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Spannung Batterie') }}:</strong></td>
        <td id="voltbatt" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Spannung Batteriezellen max') }}:</strong></td>
        <td id="voltmax" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Spannung Batteriezellen min') }}:</strong></td>
        <td id="voltmin" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Spannung Batteriezellen Differenz') }}:</strong></td>
        <td id="voltdiff" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Temperatur Batterie') }}:</strong></td>
        <td id="tempbatt" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Temperatur Batterie max') }}:</strong></td>
        <td id="tempmax" class="py-1" style="text-align: right"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Temperatur Batterie min') }}:</strong></td>
        <td id="tempmin" class="py-1" style="text-align: right"></td>
      </tr>
	  </tbody>
  </table>
  </div>
  <div class="col">
  <p></p>
  <table id="byd_diag_home" border="1">
	  <tbody>
      <tr>
        <td class="py-1"><strong>{{ _('Wechselrichter') }}:</strong></td>
        <td id="invtype" class="py-1">{{ _('Laden') }} ...</td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Batterietyp') }}:</strong></td>
        <td id="batttype2" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Seriennummer') }}:</strong></td>
        <td id="serial" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Türme') }}:</strong></td>
        <td id="bmsqty" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Module pro Turm') }}:</strong></td>
        <td id="modules" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Parameter') }}:</strong></td>
        <td id="grid" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Fehler') }}:</strong></td>
        <td id="errorstr" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>BMS:</strong></td>
        <td id="bms" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>BMU:</strong></td>
        <td id="bmu" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>BMU A:</strong></td>
        <td id="bmubanka" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>BMU B:</strong></td>
        <td id="bmubankb" class="py-1"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>P/T:</strong></td>
        <td id="paramt" class="py-1"></td>
      </tr>
	  </tbody>
  </table>
  </div>
  </div>
</div>
{% endblock bodytab1 %}


<!--
	Content block for the second tab of the Webinterface
-->
{% set tab2title = "<strong>"+_('BYD Diagnose')+"</strong>" %}
{% block bodytab2 %}
<div>
  <p></p>
  <table id="byd_diag_table" border="1">
    <thead>
      <tr>
        <th class="py-1" width=40%></th>
        <th class="py-1" style="text-align: center" width=20%>Turm 1</th>
        <th class="py-1" style="text-align: center" width=20%>Turm 2</th>
        <th class="py-1" style="text-align: center" width=20%>Turm 3</th>
      </tr>
    </thead>
	  <tbody>
      <tr>
        <td class="py-1"><strong>SOC:</strong></td>
        <td id="t1_soc" class="py-1" style="text-align: center"></td>
        <td id="t2_soc" class="py-1" style="text-align: center"></td>
        <td id="t3_soc" class="py-1" style="text-align: center"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Batteriespannung') }}:</strong></td>
        <td id="t1_bat_voltag" class="py-1" style="text-align: center"></td>
        <td id="t2_bat_voltag" class="py-1" style="text-align: center"></td>
        <td id="t3_bat_voltag" class="py-1" style="text-align: center"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Spannung Out') }}:</strong></td>
        <td id="t1_v_out" class="py-1" style="text-align: center"></td>
        <td id="t2_v_out" class="py-1" style="text-align: center"></td>
        <td id="t3_v_out" class="py-1" style="text-align: center"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Strom') }}:</strong></td>
        <td id="t1_current" class="py-1" style="text-align: center"></td>
        <td id="t2_current" class="py-1" style="text-align: center"></td>
        <td id="t3_current" class="py-1" style="text-align: center"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Spannung max (Zelle)') }}:</strong></td>
        <td id="t1_volt_max" class="py-1" style="text-align: center"></td>
        <td id="t2_volt_max" class="py-1" style="text-align: center"></td>
        <td id="t3_volt_max" class="py-1" style="text-align: center"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Spannung min (Zelle)') }}:</strong></td>
        <td id="t1_volt_min" class="py-1" style="text-align: center"></td>
        <td id="t2_volt_min" class="py-1" style="text-align: center"></td>
        <td id="t3_volt_min" class="py-1" style="text-align: center"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Temperatur max (Zelle)') }}:</strong></td>
        <td id="t1_temp_max" class="py-1" style="text-align: center"></td>
        <td id="t2_temp_max" class="py-1" style="text-align: center"></td>
        <td id="t3_temp_max" class="py-1" style="text-align: center"></td>
      </tr>
      <tr>
        <td class="py-1"><strong>{{ _('Temperatur min (Zelle)') }}:</strong></td>
        <td id="t1_temp_min" class="py-1" style="text-align: center"></td>
        <td id="t2_temp_min" class="py-1" style="text-align: center"></td>
        <td id="t3_temp_min" class="py-1" style="text-align: center"></td>
      </tr>
	  </tbody>
  </table>
</div>
{% endblock bodytab2 %}

<!--
	Content block for the third tab of the Webinterface
-->
{% set tab3title = "<strong>"+_('BYD Spannungen')+"</strong>" %}
{% block bodytab3 %}
<table style="background-color:#000000;">
  <tr>
    <td><img id="bydvt1" alt="Turm 1 nicht vorhanden" src="static/img/bydvt1.png"></td>
  </tr>
  <tr>
    <td><img id="bydvt2" alt="Turm 2 nicht vorhanden" src="static/img/bydvt2.png"></td>
  </tr>
  <tr>
    <td><img id="bydvt3" alt="Turm 3 nicht vorhanden" src="static/img/bydvt3.png"></td>
  </tr>
</table>
{% endblock bodytab3 %}
</table>

<!--
	Content block for the fourth tab of the Webinterface
-->
{% set tab4title = "<strong>"+_('BYD Temperaturen')+"</strong>" %}
{% block bodytab4 %}
<table style="background-color:#000000;">
  <tr>
    <td><img id="bydtt1" alt="Turm 1 nicht vorhanden" src="static/img/bydtt1.png"></td>
  </tr>
  <tr>
    <td><img id="bydtt2" alt="Turm 2 nicht vorhanden" src="static/img/bydtt2.png"></td>
  </tr>
  <tr>
    <td><img id="bydtt3" alt="Turm 3 nicht vorhanden" src="static/img/bydtt3.png"></td>
  </tr>
</table>
{% endblock bodytab4 %}
